<style>body { text-align: justify }</style>

# Rapport de l'audit de sécurité - SAÉ 3 Cyber 04

Nathan COUQUEBERG & Brewal GUYON

## 1. Présentation du Document

### a. Objet du Pentest

Le Pentest, également appelé test d'intrusion, a pour objectif d'évaluer la sécurité d'un système informatique, d'une application ou d'un réseau. Nous cherchons à identifier et à exploiter les vulnérabilités potentielles afin d'aider les organisations à renforcer leur sécurité. Ces tests visent à évaluer la résistance d'un système aux attaques, et à découvrir des vulnérabilités dues à des failles. Le Pentest a pour finalité l'établissement d'un plan d'action correctives afin de renforcer la sécurité du système contre les menances potentielles.

### b. Condition d'Exécution du Pentest

Le Pentest que nous opérons est de type "Black Box" : nous ne connaissons rien de la machine que nous visons à part son adresse IP. Cela a pour but de simuler une attaque réelle, et par conséquent d'identifier les points d'entrées potentiels pour mieux les corriger. Nous allons donc effectuer le Pentest, non seulement du site Web de votre site de céramiques, mais également de la machine hébergeant celui-ci, incluant les services installés qui sont accessibles de l'extérieur.

## 2. Résultats du Pentest

### a. Synthèse Non Technique

Ce paragraphe présente les conclusions du Pentest sur les aspects utilisateurs et sur la qualité de la politique de sécurité de l'entreprise. Suite à l'analyse de la machine ciblée par le Pentest, nous avons pu identifier plusieurs vulnérabilités. Elles sont pour la plupart faciles à exploiter et peuvent compromettre l'intégrité et la disponibilité de votre site web, ainsi que la confidentialité des données stockées sur la machine. Nous avons aussi pu constater des lacunes dans votre politique de sécurité. Votre politique de mots de passe est très faible, tous les comptes possèdent le même mot de passe que leur nom d'utilisateur. Les permissions de ceux-ci sont également trop élevées, un simple utilisateur ne devrait pas avoir accès aux mots de passe stockés sur la machine. Enfin, il n'y a pas de politique de mise à jour pour la machine. La version de son système d'exploitation ne dispose plus des dernières mises à jour de sécurité, et ce depuis avril 2021. Les programmes et services installés sont également obsolètes.

### b. Synthèse Technique

Dans cette catégorie, nous exposerons les résultats du Pentest sur la sécurisation des services et de leur configuration.

Commençons par le service `ProFTPD`. Il est en version `1.3.3c`, sortie en octobre 2010 soit il y a plus de 13 ans. Il n'est donc pas à jour et possède de nombreuses vulnérabilités pouvant être exploitées par des personnes malintentionnées. Le service dispose par exemple d'une porte dérobée permettant à n'importe quel utilisateur tapant une commande précise d'ouvrir un terminal sur la machine. La configuration du service est celle par défaut, elle corrige déjà certains points de défaillances mais n'est pas suffisante quand le service est destiné à être accessible depuis l'extérieur. Par exemple, elle ne bloque pas les adresses IP envoyant trop de requêtes, ce qui facilite grandement l'exécution d'attaques par force brute ou déni de service. La configuration du service autorise également la connexion en tant qu'utilisateur anonyme, ce qui n'est pas conseillé pour un service en production. Dans votre cas, quelqu'un connecté en tant qu'`anonymous` ou `ftp` peut lire le contenu du fichier `/media/ftp/update.txt`. Celui-ci n'est destiné qu'au personnel de l'enterprise, et son contenu peut donner à un potentiel attaquant une indication sur la présence du site internet "caché".

Le service `OpenSSH` est lui aussi vulnérable, étant en version `7.2p2` sortie en mars 2016. Il est notamment possible d'énumérer la liste des utilisateurs existants sur la machine, ou encore d'injecter des commandes à cause d'une faille dans l'implémentation du protocole `SCP`. Sa configuration est elle aussi celle par défaut et il n'y a aucune mesure empêchant les attaques par déni de service ou par force brute.

Le service `Apache` quant à lui est en version `2.4.18`, qui date de décembre 2015. Il possède lui aussi des vulnérabilités, principalement dues à sa mauvaise configuration. Celle-ci rend en effet plus simples les attaques par déni de service, ne bloquant pas les addresses IP envoyant trop de requêtes, et laissant ouvert des sessions utilisateurs trop longtemps.

### c. Synthèse des Vulnérabilités Prioritaires

Voici une liste des 3 vulnérabilités les plus critiques de la machine, sur lequelles il faut se concentrer en piorité. Nous évoquerons également la complexité de les corriger.

#### ProFTPD - Backdoor

Comme mentionné plus haut, la version du service `ProFTPD` sur votre machine possède une porte dérobée (ou backdoor). N'importe qui se connectant via le protocole `FTP` peut ouvrir un terminal lui permettant d'exécuter des commandes en tant que l'utilisateur `root`, c'est-à-dire en disposant des privilèges administrateurs. Cette vulnérabilité est critique car l'attaquant contrôle la machine et peut alors faire ce qu'il veut pour nuire à votre entreprise. Par exemple, il peut modifier votre site internet pour récupérer les codes de carte de crédit de vos clients ou encore s'étendre sur d'autres machines de votre réseau pour y installer des cryptovirus (ou ransomware). Cette vulnérabilité est heureusement assez simple à corriger. Il faut mettre à jour le service à sa dernière version.

#### Mot de passe de l'administrateur WordPress

Le CMS `WordPress` derrière votre site internet n'est pas sécurisé, en plus d'être obsolète. Il est en effet en version `4.9.24` et possède une configuration vulnérable. Lors de l'installation du CMS, le mot de passe choisi pour l'administrateur par défaut `admin` est `admin`. Le fait que le site `WordPress` soit dans le dossier `/secret/` ne permet pas de limiter les risques. En effet, des outils comme `gobuster` permettent très facilement de lister les dossiers et fichiers d'un site web. Cette mauvaise configuration est elle aussi facile à corriger. Il suffit de changer le nom d'utilisateur afin qu'il soit plus difficile à deviner, et le mot de passe pour qu'il soit plus sécurisé.

#### Mot de passe des utilisateurs Ubuntu

Le seul utilisateur avec lequel on peut se connecter via `SSH` est `marlinspike`. Le problème est que son mot de passe est beaucoup trop facile à deviner, comme il est identique au nom d'utilisateur. On peut donc ouvrir une session `SSH` sur la machine, et même élever ses privilèges très facilement car l'utilisateur `root` n'a pas de mot de passe. Tout comme le mot de passe de l'administrateur WordPress, il est facile de renforcer la sécurité d'accès à la machine en changeant le mot de passe de l'utilisateur `marlinspike`, et en définissant un mot de passe fort pour `root`.

### d. Actions Correctives Recommandées

Il est important de mettre à jour la version d'`Ubuntu`, dont le support s'est arrêté en avril 2021, et les services présents sur la machine, tous obsolètes. En décembre 2023, la dernière version `LTS` (Long Term Support) d'Ubuntu est la `22.04`, qui disposera de mises à jour de sécurité jusqu'en avril 2027. Vous pouvez vous informer sur les dernières mises à jour et documentations des services [ProFTPD](http://www.proftpd.org/), [OpenSSH](https://www.openssh.com/) et [Apache](https://httpd.apache.org/) sur leurs sites respectifs et les télécharger à l'aide du gestionnaire de paquets `APT`.

Comme énoncé précédemment, les utilisateurs `marlinspike` sur `Ubuntu` et `admin` sur `WordPress` ont des mots de passe trop faibles et faciles à deviner. L'administrateur de la machine, `root`, ne possède pas de mot de passe, ce qui permet à un simple utilisateur de devenir administrateur avec la commande `sudo su`. Pour corriger ces failles de configuration, vous pouvez suivre les [recommandations de l'ANSSI](https://cyber.gouv.fr/publications/recommandations-relatives-lauthentification-multifacteur-et-aux-mots-de-passe) en matière de sécurité des mots de passe.

Il est aussi fortement recommandé de diminuer les permissions de `marlinspike`. En effet, il peut non seulement consulter les fichiers `/etc/shadow` et `/etc/passwd`, contenant les identifiants des utilisateurs du système, mais aussi écrire dans ce dernier. Cela peut permettre à un simple utilisateur d'élever ses privilèges en modifiant le mot de passe de `root`. Pour remédier à ce problème, évitez le plus possible d'accorder les permissions d'écriture aux utilisateurs, notamment pour des fichiers systèmes et de configuration.

De plus, vous pouvez changer la configuration des services `ProFTPD`, `OpenSSH` et `Apache` pour limiter les attaques comme celles par force brute et déni de service. Pour cela, voici les pratiques recommandées pour les fichiers de configuration de [ProFTPD](http://www.proftpd.org/docs/howto/BCP.html), [OpenSSH](https://www.digitalocean.com/community/tutorials/how-to-harden-openssh-on-ubuntu-20-04) et [Apache](https://httpd.apache.org/docs/2.4/misc/security_tips.html). Bannir les adresses IP effectuant trop de requêtes à la suite peut également renforcer la sécurité de la machine. Je vous invite à vous renseigner sur le service [fail2ban](https://www.fail2ban.org).

Enfin, la politique de sécurité peut être modifiée afin d'instaurer ou de renforcer les directives à suivre. Vous pouvez y ajouter votre nouvelle politique de mots de passe, de gestion des autorisations ou encore de mise à jour.

## 3. Surface d'Attaque du Pentest

### a. Service ProFTPD

Le service ProFTPD (Professional FTP Daemon) est un serveur FTP (File Transfer Protocol) open-source. Il offre la possibilité de transférer des fichiers entre un client et un serveur et utilise par défaut le port TCP 21 pour la signalisation et TCP 20 pour le transfert de données en mode actif. En mode passif, le serveur et le client se mettent d'accord sur les ports à utiliser pour le transfert de données.

#### Backdoor

Du 28 novembre au 2 décembre 2010, une version compromise du service ProFTPD 

```
Description du service, usage normal de ce service, liste ordonnée des vulnérabilités par criticité décroissante, exploitation possible. Actions correctives.
```

### b. Service OpenSSH

### c. Service Apache

On a pas mis de vulnérabilités du service en question, mais plutôt de WordPress, qui tourne dessus.
Justifier qu'on a fait ça parce-qu'on a pas trouvé de faille sur Apache car les modules vulnérables étaient pas activés.

Donc on a pris des vulnérabilités web, possibles en étant admin sur WordPress


### c. Apache2

Le service Apache 2 a pour objectif d'héberger le site web. Dans notre cas, il tourne sur son port par défaut (TCP 80). Le site web hébergé est un WordPress basique contenu dans le répertoire `/secret/`. Le contenu hébergé est celui par défaut après l'installation.

#### 1) Exécution de code arbitraire dans WordPress

![web1](images/cartouche_web_1.png)

CVSS 3.1 : AV:N/AC:L/PR:H/UI:N/S:C/C:H/I:H/A:H

L'exécution de code arbitraire est possible en injectant un module vulnérable dans le WordPress. Cette vulnérabilité est utilisable par un attaquant à la seule condition qu'il réussisse à se connecter en tant qu'administrateur (ou équivalent) sur le site web.

Pour empécher l'utilisation de cette vulnérabilité, il faut modifier le mot de passe de l'utilisateur administrateur afin de le rendre plus complexe<sub>(1)</sub>. De plus, il est conseillé de modifier le nom de cet utilisateur (par défaut `admin`). L'exécution de ce service dans un conteneur et la mise en place d'une DMZ sont aussi des mesures recommandées afin de limiter les dégâts en cas de compromisson.

<sub>(1)</sub> Voir les recommandations de l'ANSSI énoncées plus haut

Pour reproduire la faille, il est nécessaire de se connecter en tant qu'administrateur au WordPress puis d'installer le module [Reflex Gallery en version 3.1.3](https://www.exploit-db.com/apps/ad33afbc2f2e22877b202d986acd43bd-reflex-gallery.zip). Une fois le module installé, il est possible d'utiliser une vulnérabilité dans ce dernier afin d'envoyer des fichiers PHP sur le serveur. En envoyant du code malveillant, il est donc possible de compromettre la machine. Un script d'exploitation permettant d'exécuter des commandes est contenu dans le fichier `scripts/exploit-web1.py`.

#### 2) XSS (Cross Site Scripting) dans WordPress

![web2](images/cartouche_web_2.png)

CVSS 3.1 : AV:N/AC:L/PR:H/UI:N/S:C/C:H/I:H/A:H

Une XSS (stockée) est possible en injectant du JavaScript sur les pages du site (avec les modules WordPress). Cette vulnérabillité permet à un attaquant de récuperer des informations et de rediriger sur d'autres sites les clients visitant le site web. Il faut néanmoins que l'attaquant ait les privilèges d'administrateur afin de la mettre en place.

Afin d'empêcher l'utilisation de cette vulnérabilité, il faut sécuriser le mot de passe administrateur. Comme pour la vulnérabilité précédente, il donc est nécessaire de modifier ce mot de passe car il est actuelement trop faible. Il est aussi conseillé de modifier le nom d'utilisateur de `admin`. La mise en place d'une CSP (Content Security Policy) est une bonne pratique si jamais le contenu du site devenait vulnérable à une XSS d'un utilisateur non administrateur.

Afin de reproduire cette faille, il est nécessaire de se connecter en administrateur du site WordPress. Une fois cela fait, il faut installer l'extension `WP Code`. Cette extension va permettre d'exécuter du JavaScript sur les pages du site. Ensuite, il faut créer un snippet qui a pour cible toutes les pages du site web. Par exemple, si un attaquant veut rediriger tous les utilisateurs visitant le site sur `example.com`, il suffirait d'exécuter \<script\>window.location = "http://example.com"\</script\>

#### 3) Deni de service avec Slowloris

![web3](images/cartouche_web_3.png)

CVSS 3.1 : AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H

Le concept de cette vulnérabilité est d'ouvrir un grand nombre de sessions avec le serveur web. Le script essaye ensuite de les garder le plus longtemps possible ouvertes. Une fois qu'un nombre suffisant de sessions ont été créées pour dépasser la capacité de puissance de calcul du serveur, le site web devient inaccessible. 

Pour régler une partie de cette vulnérabilité, il est conseillé de mettre à jour le serveur web (Apache) à la dernière version disponible. Cette mesure permettra de mieux gérer l'ouverture de sessions longues. Afin d'empêcher que le serveur soit surchargé, il est possible de modifier la configuration d'Apache afin d'accepter un nombre défini de requêtes venant d'un seul utilisateur. L'utilisation d'une protection Anti-DDOS comme celle de CloudFlare est un moyen plus efficace de ce prémunir de ce type d'attaque.

L'exploitation de cette vulnérabilité passe par l'utilisation d'un outil appelé `pwnloris`. Cet outil, disponible [ici](https://github.com/h0ussni/pwnloris), initie un grand nombre de connexions à une cible puis essaye de les garder ouvertes le plus longtemps possible. Ce DOS dépend de la puissance du serveur qui héberge le site web. Pour améliorer son efficacité, il est possible d'augmenter le nombre de machines exécutant le script en parallèle.